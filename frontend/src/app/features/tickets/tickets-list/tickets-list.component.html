<app-layout>
  <div class="tickets-container">
    <div class="header">
      <h1>Tickets</h1>
      <button mat-raised-button color="primary" routerLink="/tickets/new">
        <mat-icon>add</mat-icon>
        New Ticket
      </button>
    </div>

    <!-- Filters -->
    <div class="filters">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search</mat-label>
        <input matInput
               [(ngModel)]="searchQuery"
               (keyup.enter)="onSearch()"
               placeholder="Search tickets...">
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Status</mat-label>
        <mat-select [(ngModel)]="statusFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">All</mat-option>
          <mat-option *ngFor="let status of statuses" [value]="status">
            {{ status }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Priority</mat-label>
        <mat-select [(ngModel)]="priorityFilter" (selectionChange)="onFilterChange()">
          <mat-option value="">All</mat-option>
          <mat-option *ngFor="let priority of priorities" [value]="priority">
            {{ priority }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-button (click)="clearFilters()">
        <mat-icon>clear</mat-icon>
        Clear
      </button>
    </div>

    <!-- Loading -->
    <app-loading-spinner *ngIf="loading" [message]="'Loading tickets...'"></app-loading-spinner>

    <!-- Empty State -->
    <app-empty-state *ngIf="!loading && tickets.length === 0"
                     icon="inbox"
                     title="No tickets found"
                     message="Create your first ticket or adjust your filters"
                     actionText="Create Ticket"
                     [action]="() => {}"></app-empty-state>

    <!-- Tickets Table -->
    <div *ngIf="!loading && tickets.length > 0" class="table-container">
      <table mat-table [dataSource]="tickets" class="tickets-table">
        <!-- ID Column -->
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>ID</th>
          <td mat-cell *matCellDef="let ticket">
            <span class="ticket-id">#{{ ticket.id }}</span>
          </td>
        </ng-container>

        <!-- Title Column -->
        <ng-container matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef>Title</th>
          <td mat-cell *matCellDef="let ticket">
            <a [routerLink]="['/tickets', ticket.id]" class="ticket-title">
              {{ ticket.title }}
            </a>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let ticket">
            <mat-chip [class]="getStatusClass(ticket.status)">
              {{ ticket.status }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Priority Column -->
        <ng-container matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef>Priority</th>
          <td mat-cell *matCellDef="let ticket">
            <mat-chip [class]="getPriorityClass(ticket.priority)">
              {{ ticket.priority }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Customer Column -->
        <ng-container matColumnDef="customer">
          <th mat-header-cell *matHeaderCellDef>Customer</th>
          <td mat-cell *matCellDef="let ticket">
            {{ ticket.customerName || ticket.customerEmail || 'Unknown' }}
          </td>
        </ng-container>

        <!-- Assignee Column -->
        <ng-container matColumnDef="assignee">
          <th mat-header-cell *matHeaderCellDef>Assignee</th>
          <td mat-cell *matCellDef="let ticket">
            {{ ticket.assignedAgentName || 'Unassigned' }}
          </td>
        </ng-container>

        <!-- Created At Column -->
        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef>Created</th>
          <td mat-cell *matCellDef="let ticket">
            {{ ticket.createdAt | timeAgo }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let ticket">
            <button mat-icon-button [routerLink]="['/tickets', ticket.id]">
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <mat-paginator [length]="totalElements"
                     [pageSize]="pageSize"
                     [pageIndex]="pageIndex"
                     [pageSizeOptions]="[10, 25, 50, 100]"
                     (page)="onPageChange($event)">
      </mat-paginator>
    </div>
  </div>
</app-layout>
