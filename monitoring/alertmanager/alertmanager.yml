# =================================================================
# ServiceDesk Platform - Alertmanager Configuration
# =================================================================

global:
  # SMTP configuration for email alerts
  # NOTE: For production, consider using Docker secrets or external secret management
  # (e.g., HashiCorp Vault, AWS Secrets Manager) for sensitive SMTP credentials
  smtp_smarthost: '${SMTP_HOST:-smtp.gmail.com}:${SMTP_PORT:-587}'
  smtp_from: '${SMTP_FROM:-alertmanager@servicedesk.local}'
  smtp_auth_username: '${SMTP_USERNAME:-}'
  smtp_auth_password: '${SMTP_PASSWORD:-}'
  smtp_require_tls: true

  # Slack configuration (optional)
  slack_api_url: '${SLACK_WEBHOOK_URL:-}'

  # Default timeout for resolving alerts
  resolve_timeout: 5m

# Alert templates
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route configuration
route:
  # Default receiver
  receiver: 'default-receiver'
  
  # Group alerts by these labels
  group_by: ['alertname', 'severity', 'service']
  
  # Wait before sending a notification for a group
  group_wait: 30s
  
  # Wait before sending another notification for a group
  group_interval: 5m
  
  # Wait before sending a repeat notification
  repeat_interval: 4h

  # Child routes
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      group_interval: 1m
      repeat_interval: 1h
      continue: true

    # Warning alerts
    - match:
        severity: warning
      receiver: 'warning-receiver'
      group_wait: 1m
      group_interval: 5m
      repeat_interval: 4h

    # Database alerts
    - match:
        job: postgres
      receiver: 'database-receiver'
      group_wait: 30s
      group_interval: 5m

    # Application alerts
    - match:
        job: servicedesk-monolith
      receiver: 'application-receiver'
      group_wait: 30s
      group_interval: 5m

# Inhibit rules - suppress alerts based on other alerts
inhibit_rules:
  # Suppress warning when critical is firing
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

  # Suppress all alerts when service is down
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.*'
    equal: ['service']

# Receivers configuration
receivers:
  # Default receiver
  - name: 'default-receiver'
    email_configs:
      - to: '${ALERT_EMAIL:-admin@servicedesk.local}'
        send_resolved: true
        headers:
          Subject: '[ServiceDesk Alert] {{ .GroupLabels.alertname }}'

  # Critical alerts receiver
  - name: 'critical-receiver'
    email_configs:
      - to: '${ALERT_EMAIL:-admin@servicedesk.local}'
        send_resolved: true
        headers:
          Subject: '[CRITICAL] ServiceDesk: {{ .GroupLabels.alertname }}'
    # Uncomment to enable Slack notifications
    # slack_configs:
    #   - channel: '#alerts-critical'
    #     send_resolved: true
    #     title: '{{ .GroupLabels.alertname }}'
    #     text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
    #     color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'

  # Warning alerts receiver
  - name: 'warning-receiver'
    email_configs:
      - to: '${ALERT_EMAIL:-admin@servicedesk.local}'
        send_resolved: true
        headers:
          Subject: '[WARNING] ServiceDesk: {{ .GroupLabels.alertname }}'

  # Database alerts receiver
  - name: 'database-receiver'
    email_configs:
      - to: '${DBA_EMAIL:-dba@servicedesk.local}'
        send_resolved: true
        headers:
          Subject: '[DATABASE] ServiceDesk: {{ .GroupLabels.alertname }}'

  # Application alerts receiver
  - name: 'application-receiver'
    email_configs:
      - to: '${DEV_EMAIL:-dev@servicedesk.local}'
        send_resolved: true
        headers:
          Subject: '[APP] ServiceDesk: {{ .GroupLabels.alertname }}'
